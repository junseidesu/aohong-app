# 在庫単価転記アプリ

Excel の既存帳票（単価表 / 在庫表 / 売上分析表）間で単価・利益情報を転記・計算するための Python + CustomTkinter GUI アプリケーションです。

## 特長
- **自動単価転記**: 単価表 ("一般総平均" シート) から対象年月の ID/単価を抽出し在庫表へ一括転記
- **利益計算**: 在庫表に反映済み単価を用いて売上表に利益・利益率を自動計算し書き込み
- **高機能設定ウィンドウ**: 
  - Excel ファイルパスの選択・参照・フォルダ開く・クリア機能
  - 行・列番号の数値入力フィールド（リアルタイム検証付き）
  - スクロール対応で画面サイズに応じた動的リサイズ
  - 未保存変更の確認ダイアログ
  - 変更箇所のハイライト表示と保存時のフラッシュエフェクト
- **進行状況表示**: プログレスバーとステータス表示で処理の進捗を可視化
- **UI自動調整**: ウィンドウサイズがコンテンツに応じて自動フィット（横幅・縦幅ともにコンパクト化）
- **設定永続化**: JSON による設定保存。欠損キーは自動でデフォルト補完
- **ユーザビリティ**: 設定ウィンドウは最前面表示、既存インスタンス再利用、即時UI反映

## 動作要件
- Python 3.10 以降 (3.13 でも動作確認)
- Windows (他 OS でも基本的には動く想定ですが未検証)
- 必要ライブラリ:
  - `customtkinter`
  - `openpyxl`

### インストール
PowerShell:
```powershell
pip install customtkinter openpyxl
```

## ファイル構成 (抜粋)
```
main.py                # アプリ本体
settings.json          # 保存された設定 (初回は無い場合あり)
2025在庫.xlsx
フロンガス単価表2025.xlsx
R706 得意先別売上分析表.xlsx
reclaim_icon.ico       # アイコン
```

## 実行
PowerShell でリポジトリディレクトリに移動して:
```powershell
python .\main.py
```

## 使い方

### 基本操作
1. **年月選択**: アプリ起動後、対象の「年」「月」をドロップダウンで選択
2. **在庫単価転記**: 「在庫単価を在庫表に転記」ボタンで単価表→在庫表へ単価一括反映
   - 処理中はプログレスバーで進捗表示
   - 完了時に更新件数を表示
3. **売上表利益計算**: 「在庫単価を売上表に転記」ボタンで在庫表の単価を使って売上表へ利益・利益率計算反映
   - 100行ごとに進捗更新
   - 計算エラー行はスキップして継続処理

### 設定ウィンドウの使い方
1. **設定ウィンドウを開く**: メインウィンドウの「設定」ボタンをクリック
2. **ファイルパス設定**:
   - 各ファイルパス入力欄の「参照」ボタンでファイル選択
   - 「開く」ボタンで設定済みファイルのフォルダをエクスプローラで開く
   - 「クリア」ボタンでパスをクリア
3. **行・列番号設定**:
   - 数値入力フィールドに直接入力（正の整数のみ受け付け）
   - 不正な値は保存時にエラー表示
   - デフォルト値と異なる場合は背景色でハイライト
4. **保存・リセット**:
   - 「設定を保存」で設定をJSON に保存（保存時にフラッシュエフェクト）
   - 「設定をリセット」でデフォルト値に戻して自動保存
   - 未保存の変更がある状態で閉じる場合は確認ダイアログを表示

### ウィンドウサイズとレイアウト
- **自動リサイズ**: ウィンドウサイズがコンテンツに応じて自動調整
- **コンパクト設計**: 横幅340px、縦幅240pxを基準とした省スペース設計
- **スクロール対応**: 設定ウィンドウは内容が多い場合にスクロール表示
- **動的制約**: 画面サイズの80-85%を上限とした自動サイズ制限

## 設定 (Settings クラス)

### 設定システムの特徴
- **単一ソース**: `Settings._DEFAULT_VALUES` が唯一のデフォルト定義
- **自動補完**: 起動時に `settings.json` で設定を上書き、欠損キーは自動補完
- **ライブ更新**: 設定変更時にメインUIが即座に反映
- **検証機能**: 数値設定の妥当性チェック（正の整数のみ）

### 設定可能項目

#### ファイルパス設定
- `PRICE_FILE_PATH`: 単価表ファイル（デフォルト: "フロンガス単価表2025.xlsx"）
- `STOCK_FILE_PATH`: 在庫表ファイル（デフォルト: "2025在庫.xlsx"）  
- `SALES_FILE_PATH`: 売上表ファイル（デフォルト: "R706 得意先別売上分析表.xlsx"）

#### 単価表の行・列設定
- `ID_ROW_IN_PRICE`: ID行番号（デフォルト: 3）
- `PRICE_ROW_IN_PRICE`: 単価行番号（デフォルト: 25）

#### 在庫表の行・列設定  
- `ID_COLUMN_IN_STOCK`: ID列番号（デフォルト: 3）
- `PRICE_COLUMN_IN_STOCK`: 単価列番号（デフォルト: 10）
- `DATA_START_ROW_IN_STOCK`: データ開始行（デフォルト: 7）

#### 売上表の行・列設定
- `ID_COLUMN_IN_SALES`: ID列番号（デフォルト: 4）
- `PROFIT_COLUMN_IN_SALES`: 利益列番号（デフォルト: 9）
- `PROFIT_RATE_COLUMN_IN_SALES`: 利益率列番号（デフォルト: 10）
- `SALES_COLUMN_IN_SALES`: 売上列番号（デフォルト: 6）
- `SALES_NUM_COLUMN_IN_SALES`: 売上数量列番号（デフォルト: 8）

#### UI設定
- `APP_NAME`: アプリケーション名（デフォルト: "在庫単価転記アプリ"）
- `WINDOW_WIDTH`: ウィンドウ幅（デフォルト: 340px）
- `WINDOW_HEIGHT`: ウィンドウ高さ（デフォルト: 240px）
- `THEME`: 外観テーマ（デフォルト: "dark"）
- `COLOR_THEME`: カラーテーマ（デフォルト: "blue"）
- `ICON_FILE`: アイコンファイル（デフォルト: "reclaim_icon.ico"）

### `settings.json` 例
```json
{
  "files": {
    "price_file_path": "フロンガス単価表2025.xlsx",
    "stock_file_path": "2025在庫.xlsx",
    "sales_file_path": "R706 得意先別売上分析表.xlsx"
  },
  "positions": {
    "id_row_in_price": 3,
    "price_row_in_price": 25,
    "id_column_in_stock": 3,
    "price_column_in_stock": 10,
    "data_start_row_in_stock": 7,
    "id_column_in_sales": 4,
    "profit_column_in_sales": 9,
    "profit_rate_column_in_sales": 10,
    "sales_column_in_sales": 6,
    "sales_num_column_in_sales": 8
  }
}
```

### 値の適用フロー
1. **起動時**: `Settings.load_settings()` がデフォルトで初期化後、JSON設定を反映
2. **UI参照**: メインUIがSettingsのクラス変数値を参照してレイアウト構築
3. **設定変更**: 設定ウィンドウでファイル選択・数値入力 → クラス変数を即時更新（未保存状態）
4. **保存処理**: 「設定を保存」→ JSON書き込み → `App.refresh_settings_ui()` でUI更新 → フラッシュエフェクト
5. **次回起動**: 保存された設定値が自動的に復元

### 設定ファイルの検証
- **ファイル存在チェック**: 起動時に設定ファイルの存在を確認
- **キー補完**: JSON内に欠損しているキーは自動的にデフォルト値で補完
- **型検証**: 数値設定は正の整数のみ受け付け、不正値は保存時にエラー表示
- **フォールバック**: 設定読み込みエラー時はデフォルト値で安全に動作

## 処理ロジック詳細

### 在庫単価転記プロセス
1. **年月文字列生成**: 選択された年月から YYYYMM 形式の文字列を構築
2. **単価表解析**: 
   - "一般総平均" シートの1行目で対象年月セルを検索
   - 次月開始列または空列までの範囲を特定
3. **ID-単価辞書構築**: 
   - ID_ROW（デフォルト3行目）とPRICE_ROW（デフォルト25行目）を走査
   - 有効なID/単価ペアで辞書を作成
4. **在庫表更新**:
   - シート名にYYYYMMを含むシートを検索・選択
   - 各行のIDに対応する単価を辞書から取得して更新
   - 50行ごとに進捗バー更新、処理件数をカウント

### 売上表利益計算プロセス  
1. **在庫単価辞書作成**: 在庫表のデータ開始行以降からID→単価の辞書を構築
2. **売上表スキャン**: 
   - 売上表を1行目から最終行まで全走査
   - 各行のIDが辞書に存在するかチェック
3. **利益計算実行**:
   - 売上金額と売上数量を取得
   - 利益 = 売上金額 - (売上数量 × 単価)
   - 利益率 = 利益 ÷ 売上金額  
4. **結果書き込み**: 
   - 計算結果を指定列に書き込み
   - 100行ごとに進捗表示、エラー行はログ出力してスキップ

### エラーハンドリング戦略
- **ファイルレベル**: FileNotFoundError、PermissionError は GUI メッセージボックスで通知
- **データレベル**: ValueError、TypeError、ZeroDivisionError はコンソールログ出力し処理継続  
- **設定レベル**: 不正な数値入力は保存時にGUIでエラー表示
- **UI レベル**: ウィンドウサイズ取得失敗などはフォールバック値で復旧

## テクニカル仕様詳細

### アーキテクチャ設計
- **フレームワーク**: CustomTkinter による現代的な GUI デザイン
- **設定管理**: JSON ベースの動的設定システム（リアルタイム UI 反映）
- **データ処理**: openpyxl によるメモリ効率的な Excel 操作
- **UI パターン**: MVC 風の責務分離（GUI/設定/ロジック）

### パフォーマンス最適化
- **プログレスバー**: 長時間処理の可視化（50行/100行単位更新）
- **遅延読み込み**: Excel ファイルは処理開始時のみ読み込み
- **メモリ管理**: 辞書ベース ID-単価マッピングで高速検索
- **UI レスポンス**: 重い処理中も GUI 応答性を維持

### 設定システム詳細  
- **スコープ**: グローバル設定とファイル固有設定の階層管理
- **バリデーション**: 数値型・範囲チェック・必須項目検証
- **永続化**: 自動保存と手動設定ファイル編集の両対応
- **GUI 統合**: スクロール可能な設定ウィンドウで全項目編集可能

### UI/UX 改善要素
- **レスポンシブデザイン**: 画面サイズに応じた自動調整
- **コンパクト設計**: 最適化されたウィンドウサイズとパディング
- **視覚的フィードバック**: ホバー効果・進捗表示・状態インジケーター
- **キーボードサポート**: タブ順序とショートカットキー対応

### 互換性・要件
- **Python バージョン**: Python 3.7+ 推奨
- **外部依存**: CustomTkinter, openpyxl のみ  
- **OS サポート**: Windows, macOS, Linux
- **Excel 互換**: .xlsx 形式（Excel 2007以降）対応

### セキュリティ考慮事項
- **ファイル権限**: 読み取り専用ファイルの適切な処理
- **エラー情報**: 機密データを含まないエラーメッセージ
- **設定値検証**: 不正入力による実行時エラーの防止

## 最前面表示の仕組み
設定ウィンドウ生成時に一時的に `-topmost` 属性を True にし `lift()` / `focus_force()` 後、300ms で False に戻すことで自然な前面化を実現。

## よくある質問 (FAQ)
Q. 設定を変えたのにメイン画面が変わらない。
A. 「設定を保存」ボタンを押したか確認してください。保存後は即反映されます。

Q. テーマ (THEME / COLOR_THEME) を JSON からも変更したい。
A. `save_settings()` の書き込み dict にキーを追加し、`load_settings()` で読み戻す処理を追加してください。

## 今後の改善候補
- 設定ウィンドウに数値 (行/列) 編集フィールドを追加
- 未保存変更がある状態で閉じる際の確認ダイアログ
- ログ出力 (logging) 導入とログファイル保存
- requirements.txt 追加とバージョンピン
- 単体テスト (pytest) 整備
- 進捗/件数をプログレスバーで表示

## ライセンス
(必要に応じてここにライセンス種別を記載)

## 開発者向けメモ
- デフォルト値は `_DEFAULT_VALUES` のみを編集
- UI へ新たな設定を反映したい場合は `App.refresh_settings_ui()` を拡張

---
不明点や機能追加要望があれば Issue / 連絡でお知らせください。
